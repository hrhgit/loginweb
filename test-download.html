<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件下载测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #080; }
    </style>
</head>
<body>
    <h1>Supabase 文件下载测试</h1>
    
    <div class="test-section">
        <h2>测试1: 直接访问已知文件URL</h2>
        <p>测试URL: <span id="testUrl"></span></p>
        <button onclick="testDirectAccess()">测试直接访问</button>
        <div id="directResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>测试2: 通过Supabase客户端生成URL</h2>
        <button onclick="testSupabaseClient()">测试Supabase客户端</button>
        <div id="clientResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>测试3: 下载文件</h2>
        <button onclick="testDownload()">测试下载</button>
        <div id="downloadResult" class="result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 使用实际的文件路径
        const testFilePath = 'files/74931bc0-8d72-4a1b-bd27-7225ce5f1528/5522b836-5df9-4e58-a33f-f41641cc2e43-1767011326770.zip'
        const testUrl = `https://whnetfkhvuhcavvojjxa.supabase.co/storage/v1/object/public/submission-files/${testFilePath}`
        
        document.getElementById('testUrl').textContent = testUrl
        
        // 初始化 Supabase 客户端
        const supabase = window.supabase.createClient(
            'https://whnetfkhvuhcavvojjxa.supabase.co',
            'sb_publishable_vzBphiRwGub1_cRAjiVDPg_OVB89HxF'
        )
        
        async function testDirectAccess() {
            const resultDiv = document.getElementById('directResult')
            resultDiv.textContent = '测试中...'
            
            try {
                const response = await fetch(testUrl, { method: 'HEAD' })
                if (response.ok) {
                    resultDiv.className = 'result success'
                    resultDiv.textContent = `✅ 成功! 状态: ${response.status}, 文件大小: ${response.headers.get('content-length')} 字节`
                } else {
                    resultDiv.className = 'result error'
                    resultDiv.textContent = `❌ 失败! 状态: ${response.status} ${response.statusText}`
                }
            } catch (error) {
                resultDiv.className = 'result error'
                resultDiv.textContent = `❌ 错误: ${error.message}`
            }
        }
        
        async function testSupabaseClient() {
            const resultDiv = document.getElementById('clientResult')
            resultDiv.textContent = '测试中...'
            
            try {
                const { data } = supabase.storage.from('submission-files').getPublicUrl(testFilePath)
                const generatedUrl = data.publicUrl
                
                resultDiv.innerHTML = `生成的URL: ${generatedUrl}<br>`
                
                // 测试生成的URL
                const response = await fetch(generatedUrl, { method: 'HEAD' })
                if (response.ok) {
                    resultDiv.className = 'result success'
                    resultDiv.innerHTML += `✅ 生成的URL可访问! 状态: ${response.status}`
                } else {
                    resultDiv.className = 'result error'
                    resultDiv.innerHTML += `❌ 生成的URL不可访问! 状态: ${response.status} ${response.statusText}`
                }
            } catch (error) {
                resultDiv.className = 'result error'
                resultDiv.textContent = `❌ 错误: ${error.message}`
            }
        }
        
        async function testDownload() {
            const resultDiv = document.getElementById('downloadResult')
            resultDiv.textContent = '开始下载测试...'
            
            try {
                // 创建下载链接
                const link = document.createElement('a')
                link.href = testUrl
                link.download = 'test-download.zip'
                link.target = '_blank'
                
                // 先测试URL是否可访问
                const response = await fetch(testUrl, { method: 'HEAD' })
                if (response.ok) {
                    // 触发下载
                    document.body.appendChild(link)
                    link.click()
                    document.body.removeChild(link)
                    
                    resultDiv.className = 'result success'
                    resultDiv.textContent = '✅ 下载已触发! 请检查浏览器下载文件夹'
                } else {
                    resultDiv.className = 'result error'
                    resultDiv.textContent = `❌ 下载失败! URL不可访问: ${response.status} ${response.statusText}`
                }
            } catch (error) {
                resultDiv.className = 'result error'
                resultDiv.textContent = `❌ 下载错误: ${error.message}`
            }
        }
    </script>
</body>
</html>