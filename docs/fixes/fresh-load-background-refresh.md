# é¡µé¢åˆ·æ–°æ—¶ç«‹å³åå°è¯·æ±‚ç­–ç•¥

## ç­–ç•¥æ¦‚è¿°

ä¿®æ”¹äº†ç¼“å­˜ç­–ç•¥ï¼Œç¡®ä¿**åˆšæ‰“å¼€ç½‘é¡µæˆ–åˆ·æ–°ç½‘é¡µæ—¶ç«‹å³è¿›è¡Œåå°è¯·æ±‚**ï¼ŒåŒæ—¶ä¿æŒå¿«é€Ÿçš„ç”¨æˆ·ä½“éªŒã€‚

## æ ¸å¿ƒæ”¹è¿›

### 1. é¡µé¢åŠ è½½çŠ¶æ€æ£€æµ‹

```typescript
// é¡µé¢åŠ è½½çŠ¶æ€è·Ÿè¸ª
let isPageFreshLoad = true
const pageLoadStartTime = Date.now()

// æ£€æµ‹é¡µé¢æ˜¯å¦æ˜¯åˆšåˆ·æ–°çš„
const isPageJustRefreshed = (): boolean => {
  // ä½¿ç”¨ Performance API æ£€æµ‹é¡µé¢åŠ è½½ç±»å‹
  if (typeof performance !== 'undefined' && performance.navigation) {
    return performance.navigation.type === 1 // 1 è¡¨ç¤ºåˆ·æ–°
  }
  
  // å¤‡ç”¨æ–¹æ¡ˆï¼šæ£€æŸ¥é¡µé¢åŠ è½½æ—¶é—´
  return Date.now() - pageLoadStartTime < 5000 // 5ç§’å†…è®¤ä¸ºæ˜¯åˆšåŠ è½½
}
```

### 2. æ™ºèƒ½åˆ·æ–°åˆ¤æ–­

```typescript
const shouldRefreshEvents = (): boolean => {
  // å¦‚æœæ˜¯é¡µé¢åˆšåŠ è½½ã€åˆ·æ–°ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œæ€»æ˜¯åå°è¯·æ±‚
  if (isPageFreshLoad || isPageJustRefreshed()) {
    return true
  }
  
  // å…¶ä»–æƒ…å†µæŒ‰åŸæ¥çš„é€»è¾‘ï¼ˆæ•°æ®å¹´é¾„åˆ¤æ–­ï¼‰
  // ...
}
```

## æ‰§è¡Œæµç¨‹

### æƒ…å†µ1ï¼šåˆšæ‰“å¼€ç½‘é¡µï¼ˆé¦–æ¬¡è®¿é—®ï¼‰

```
æ‰“å¼€ç½‘é¡µ
    â†“
ensureEventsLoaded()
    â†“
æ£€æŸ¥ç¼“å­˜: æ— ç¼“å­˜æ•°æ®
    â†“
æ­¥éª¤4: å¼ºåˆ¶åŒæ­¥åŠ è½½ â†’ ç½‘ç»œè¯·æ±‚ â†’ æ˜¾ç¤ºæ•°æ®
    â†“
isPageFreshLoad = false
```

### æƒ…å†µ2ï¼šåˆ·æ–°ç½‘é¡µï¼ˆæœ‰ç¼“å­˜ï¼‰

```
åˆ·æ–°ç½‘é¡µ (Ctrl+F5 æˆ– F5)
    â†“
ensureEventsLoaded()
    â†“
æ­¥éª¤1: å‘ç°ç¼“å­˜ â†’ ç«‹å³æ˜¾ç¤ºç¼“å­˜æ•°æ®
    â†“
æ­¥éª¤3: shouldRefreshEvents() 
    â”œâ”€ isPageFreshLoad = true â†’ è¿”å› true
    â””â”€ æˆ– isPageJustRefreshed() = true â†’ è¿”å› true
    â†“
åå°è¯·æ±‚ â†’ æ¯”è¾ƒæ•°æ® â†’ æ›´æ–°UIï¼ˆå¦‚æœ‰å˜åŒ–ï¼‰
    â†“
isPageFreshLoad = false
```

### æƒ…å†µ3ï¼šé¡µé¢å†…å¯¼èˆªï¼ˆSPAè·¯ç”±ï¼‰

```
ç‚¹å‡»é“¾æ¥æˆ–è·¯ç”±è·³è½¬
    â†“
ensureEventsLoaded()
    â†“
æ­¥éª¤3: shouldRefreshEvents()
    â”œâ”€ isPageFreshLoad = false
    â””â”€ isPageJustRefreshed() = false
    â†“
æŒ‰æ•°æ®å¹´é¾„åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ·æ–°
```

## æ£€æµ‹æœºåˆ¶

### 1. Performance API æ£€æµ‹

```typescript
// æ£€æµ‹é¡µé¢åŠ è½½ç±»å‹
performance.navigation.type:
  0 = navigate (æ­£å¸¸å¯¼èˆª)
  1 = reload (åˆ·æ–°)
  2 = back_forward (å‰è¿›/åé€€)
```

### 2. æ—¶é—´çª—å£æ£€æµ‹

```typescript
// å¦‚æœé¡µé¢åŠ è½½æ—¶é—´å¾ˆçŸ­ï¼Œè®¤ä¸ºæ˜¯åˆšåŠ è½½
const pageAge = Date.now() - pageLoadStartTime
return pageAge < 5000 // 5ç§’å†…
```

### 3. çŠ¶æ€æ ‡è®°

```typescript
// ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ€»æ˜¯åˆ·æ–°
let isPageFreshLoad = true

// è°ƒç”¨åé‡ç½®çŠ¶æ€
isPageFreshLoad = false
```

## ç”¨æˆ·ä½“éªŒ

### âœ… **ä¼˜ç‚¹**

1. **ç«‹å³æ˜¾ç¤º**ï¼šæœ‰ç¼“å­˜æ—¶ç«‹å³æ˜¾ç¤ºï¼Œæ— ç­‰å¾…
2. **æ•°æ®æ–°é²œ**ï¼šæ¯æ¬¡åˆ·æ–°éƒ½ä¼šè·å–æœ€æ–°æ•°æ®
3. **åå°æ›´æ–°**ï¼šä¸é˜»å¡UIï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
4. **æ™ºèƒ½åˆ¤æ–­**ï¼šé¡µé¢å†…å¯¼èˆªä¸ä¼šè¿‡åº¦è¯·æ±‚

### ğŸ“Š **è¯·æ±‚é¢‘ç‡**

- **åˆ·æ–°é¡µé¢**ï¼šæ€»æ˜¯åå°è¯·æ±‚
- **é¦–æ¬¡è®¿é—®**ï¼šåŒæ­¥è¯·æ±‚ï¼ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼‰
- **é¡µé¢å†…å¯¼èˆª**ï¼šæŒ‰æ•°æ®å¹´é¾„åˆ¤æ–­
  - ç®¡ç†å‘˜ï¼š>1åˆ†é’Ÿæ‰è¯·æ±‚
  - æ™®é€šç”¨æˆ·ï¼š>3åˆ†é’Ÿæ‰è¯·æ±‚

## è°ƒè¯•åŠŸèƒ½

### æ–°å¢è°ƒè¯•ä¿¡æ¯

```javascript
const debugInfo = store.debugEventsState()
console.log(debugInfo)

// æ–°å¢å­—æ®µï¼š
{
  pageAgeSeconds: 15,           // é¡µé¢åŠ è½½äº†å¤šå°‘ç§’
  isPageFreshLoad: false,       // æ˜¯å¦æ ‡è®°ä¸ºåˆšåŠ è½½
  isPageJustRefreshed: false,   // æ˜¯å¦æ£€æµ‹ä¸ºåˆšåˆ·æ–°
  shouldRefresh: true,          // æ˜¯å¦éœ€è¦åˆ·æ–°
  // ... å…¶ä»–ä¿¡æ¯
}
```

### è°ƒè¯•é¡µé¢æ–°åŠŸèƒ½

è®¿é—® `/debug/events` é¡µé¢ï¼š

- **é‡ç½®é¡µé¢çŠ¶æ€**ï¼šæ‰‹åŠ¨é‡ç½® `isPageFreshLoad = true`
- **æ£€æŸ¥çŠ¶æ€**ï¼šæŸ¥çœ‹é¡µé¢åŠ è½½çŠ¶æ€å’Œåˆ·æ–°åˆ¤æ–­
- **åå°åˆ·æ–°**ï¼šæ‰‹åŠ¨è§¦å‘åå°åˆ·æ–°æµ‹è¯•

## æµ‹è¯•åœºæ™¯

### 1. åˆ·æ–°é¡µé¢æµ‹è¯•

```
1. è®¿é—®é¡µé¢ï¼Œç­‰å¾…æ•°æ®åŠ è½½
2. æŒ‰ F5 åˆ·æ–°é¡µé¢
3. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼š
   - "Loaded cached events, fetching fresh data in background..."
   - "Page fresh load detected, background refresh initiated"
   - "Refreshing events in background..."
```

### 2. é¡µé¢å†…å¯¼èˆªæµ‹è¯•

```
1. åœ¨é¡µé¢é—´åˆ‡æ¢ï¼ˆå¦‚ /events â†’ /me/profile â†’ /eventsï¼‰
2. è§‚å¯Ÿæ˜¯å¦ä¼šè¿‡åº¦è¯·æ±‚
3. åº”è¯¥æŒ‰æ•°æ®å¹´é¾„åˆ¤æ–­ï¼Œä¸ä¼šæ¯æ¬¡éƒ½è¯·æ±‚
```

### 3. æ•°æ®æ›´æ–°æµ‹è¯•

```
1. ç®¡ç†å‘˜åˆ›å»ºæ–°æ´»åŠ¨
2. åˆ·æ–°é¡µé¢
3. åº”è¯¥çœ‹åˆ°æ–°æ´»åŠ¨å‡ºç°
4. æ˜¾ç¤º "æ´»åŠ¨åˆ—è¡¨å·²æ›´æ–°" æç¤º
```

## é…ç½®é€‰é¡¹

å¦‚æœéœ€è¦è°ƒæ•´è¡Œä¸ºï¼Œå¯ä»¥ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š

```typescript
// è°ƒæ•´é¡µé¢åŠ è½½æ£€æµ‹çª—å£
return Date.now() - pageLoadStartTime < 10000 // æ”¹ä¸º10ç§’

// è°ƒæ•´æ•°æ®å¹´é¾„é˜ˆå€¼
if (isAdmin.value) {
  return age > 30 * 1000  // æ”¹ä¸º30ç§’
} else {
  return age > 2 * 60 * 1000  // æ”¹ä¸º2åˆ†é’Ÿ
}
```

## æ—¥å¿—ç›‘æ§

å…³é”®æ—¥å¿—ä¿¡æ¯ï¼š

- `"Page fresh load detected, background refresh initiated"` - æ£€æµ‹åˆ°é¡µé¢åˆ·æ–°
- `"Loaded cached events, fetching fresh data in background..."` - æ˜¾ç¤ºç¼“å­˜å¹¶åå°åˆ·æ–°
- `"Refreshing events in background..."` - å¼€å§‹åå°åˆ·æ–°
- `"Fresh data received, updating events..."` - æ”¶åˆ°æ–°æ•°æ®å¹¶æ›´æ–°
- `"No changes in fresh data"` - æ•°æ®æ— å˜åŒ–ï¼Œé™é»˜å®Œæˆ

è¿™æ ·ç¡®ä¿äº†æ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½ä¼šè·å–æœ€æ–°æ•°æ®ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚